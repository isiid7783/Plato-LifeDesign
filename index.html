<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plato Network â€“ Body Avatar UI</title>

<style>
html,body{margin:0;padding:0;background:#000;color:#fff;overflow:hidden}
#app{position:fixed;inset:0}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
#controls{
  position:absolute;right:12px;bottom:80px;
  display:flex;flex-direction:column;gap:14px
}
.ctrl{
  width:46px;height:46px;border-radius:50%;
  background:rgba(0,0,0,.6);border:1px solid #fff;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;user-select:none
}
.ctrl.active{background:#fff;color:#000}
#axis{
  position:absolute;left:50%;top:0;width:1px;height:100%;
  background:rgba(255,255,255,.3)
}
</style>
</head>

<body>
<div id="app">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="axis"></div>

  <div id="controls">
    <div class="ctrl" id="rec">REC</div>
    <div class="ctrl" id="inv">INV</div>
    <div class="ctrl" id="trc">TRC</div>
    <div class="ctrl" id="axs">AXS</div>
    <div class="ctrl" id="face">FACE</div>
    <div class="ctrl" id="rst">RST</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const v=document.getElementById("video");
const c=document.getElementById("canvas");
const x=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;

let hist=[],maxH=80,rec=false,inv=false,lock=false,lockX=null;
let faceMode=1,face=null;

const btn=i=>document.getElementById(i);
btn("rec").onclick=()=>btn("rec").classList.toggle("active",rec=!rec);
btn("inv").onclick=()=>btn("inv").classList.toggle("active",inv=!inv);
btn("trc").onclick=()=>{maxH=maxH===80?240:80;btn("trc").classList.toggle("active")}
btn("axs").onclick=()=>{lock=!lock;lockX=null;btn("axs").classList.toggle("active")}
btn("face").onclick=()=>{faceMode=(faceMode+1)%3;btn("face").classList.toggle("active",faceMode)}
btn("rst").onclick=()=>hist=[];

const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({smoothLandmarks:true});

const faceMesh=new FaceMesh({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
faceMesh.setOptions({maxNumFaces:1});
faceMesh.onResults(r=>face=r.multiFaceLandmarks?.[0]);

pose.onResults(r=>{
  x.save();
  if(inv){x.filter="invert(1)"}else{x.filter="none"}
  x.drawImage(r.image,0,0,c.width,c.height);
  x.restore();

  if(r.poseLandmarks){
    let pts=[11,12,23,24].map(i=>r.poseLandmarks[i]);
    let cx=pts.reduce((a,p)=>a+p.x,0)/4;
    let cy=pts.reduce((a,p)=>a+p.y,0)/4;
    if(lock){if(lockX==null)lockX=cx;cx=lockX}
    if(rec||!hist.length){hist.push({x:cx,y:cy});if(hist.length>maxH)hist.shift()}
    x.strokeStyle=inv?"#fff":"#000";
    x.beginPath();
    hist.forEach((p,i)=>{
      let X=p.x*c.width,Y=p.y*c.height;
      i?x.lineTo(X,Y):x.moveTo(X,Y);
    });
    x.stroke();
  }

  if(face && faceMode){
    let xs=face.map(p=>p.x*c.width);
    let ys=face.map(p=>p.y*c.height);
    let cx=xs.reduce((a,b)=>a+b,0)/xs.length;
    let cy=ys.reduce((a,b)=>a+b,0)/ys.length;
    let r=Math.max(...xs.map((x,i)=>Math.hypot(x-cx,ys[i]-cy)));

    x.fillStyle=inv?"#000":"#000";
    x.beginPath();x.arc(cx,cy,r,0,Math.PI*2);x.fill();

    if(faceMode===2){
      x.strokeStyle=inv?"#fff":"#fff";
      face.forEach(p=>{
        x.beginPath();
        x.arc(p.x*c.width,p.y*c.height,1.5,0,6.28);
        x.stroke();
      });
    }
  }
});

const cam=new Camera(v,{
  onFrame:async()=>{
    await pose.send({image:v});
    await faceMesh.send({image:v});
  },
  width:720,height:1280
});
cam.start();
</script>
</body>
</html>
