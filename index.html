<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bio-Tensegrity Vertical System</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  color:#fff;
  overflow:hidden;
  font-family:system-ui,-apple-system;
}

video,canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

/* UI */
#value{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-size:110px;
  font-weight:700;
  letter-spacing:.06em;
  mix-blend-mode:screen;
  pointer-events:none;
}

#level{
  position:absolute;
  left:50%;
  top:36%;
  transform:translateX(-50%);
  font-size:14px;
  letter-spacing:.25em;
  opacity:.7;
}

#energy{
  position:fixed;
  right:22px;
  top:60px;
  bottom:60px;
  width:14px;
  background:rgba(255,255,255,.15);
  border-radius:8px;
  overflow:hidden;
}
#energyFill{
  position:absolute;
  bottom:0;
  width:100%;
  height:50%;
  background:linear-gradient(
    to top,
    #0033ff,
    #00ffff,
    #ffff00,
    #ff3300
  );
}

#timer{
  position:fixed;
  bottom:22px;
  left:50%;
  transform:translateX(-50%);
  font-size:13px;
  letter-spacing:.18em;
  opacity:.7;
}
</style>
</head>

<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="level">LEVEL 1</div>
<div id="value">--</div>

<div id="energy"><div id="energyFill"></div></div>
<div id="timer">HOLD 60s</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const valueEl = document.getElementById("value");
const levelEl = document.getElementById("level");
const fillEl  = document.getElementById("energyFill");
const timerEl = document.getElementById("timer");

canvas.width = innerWidth;
canvas.height = innerHeight;

/* CAMERA */
navigator.mediaDevices.getUserMedia({video:true})
  .then(s=>video.srcObject=s)
  .catch(e=>alert(e));

/* STATE */
let prevFrame=null;
let energy=0.5;
let level=1;
let holdTime=0;
let lastTime=performance.now();
let t=0;

/* UTILS */
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

/* LOOP */
function loop(now){
  const dt=(now-lastTime)/1000;
  lastTime=now;
  t+=dt;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);

  let activity=1;
  if(prevFrame){
    let diff=0;
    const d=frame.data,p=prevFrame.data;
    for(let i=0;i<d.length;i+=80){
      diff+=Math.abs(d[i]-p[i]);
    }
    activity=clamp(diff/(canvas.width*canvas.height)*90,0,1);
    energy=energy*0.85+(1-activity)*0.15;
  }
  prevFrame=frame;

  /* HOLD / LEVEL */
  if(activity<0.14){
    holdTime+=dt;
  }else{
    holdTime=0;
  }
  if(holdTime>=60){
    level++;
    holdTime=0;
  }

  /* ENERGY VALUE */
  const base=0.45+0.1*Math.sin(t);
  const e=clamp(base*0.4+energy*0.6,0,1);

  const maxValue=100+level*15;
  const display=Math.round(e*maxValue);

  valueEl.textContent=display;
  levelEl.textContent="LEVEL "+level;
  fillEl.style.height=(e*100)+"%";
  timerEl.textContent=
    holdTime>0 ? "HOLD "+Math.floor(60-holdTime)+"s" : "HOLD 60s";

  valueEl.style.textShadow=
    `0 0 ${16+level*6}px rgba(255,210,140,.6)`;

  /* ===============================
     BIO-TENSEGRITY SPIRAL (FIXED)
  ================================ */
  const cx=canvas.width/2;
  const cy=canvas.height/2;

  const verticalRadius = canvas.height * 0.32;
  const horizontalRadius = canvas.width * 0.12; // ← 太らない制限

  const rings = 10 + level * 2;
  const segments = 160;

  ctx.save();
  ctx.translate(cx,cy);

  for(let r=0;r<rings;r++){
    const vRatio = r / rings;
    const ry = verticalRadius * vRatio;
    const rx = horizontalRadius * vRatio;

    const twist = r * 0.55 + e * 3.2;

    ctx.beginPath();
    for(let i=0;i<=segments;i++){
      const a = i/segments * Math.PI*2;
      const spiral = a + twist;
      const noise = (1-activity) * 4 * Math.sin(a*2 + t*1.8);

      const x = Math.cos(spiral) * (rx + noise);
      const y = Math.sin(spiral) * (ry + noise);

      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }

    ctx.strokeStyle =
      `rgba(${180+e*60},${120+e*90},90,${0.05+e*0.22})`;
    ctx.lineWidth = 0.45 + e*0.7;
    ctx.stroke();
  }

  ctx.restore();

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>

</body>
</html>
