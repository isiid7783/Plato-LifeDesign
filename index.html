<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stability Stillness Index</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  font-family:system-ui,-apple-system;
  color:#fff;
  overflow:hidden;
}

/* camera */
video,canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

/* gradient frame */
#frame{
  position:fixed;
  inset:0;
  pointer-events:none;
  background:linear-gradient(
    to bottom,
    rgba(0,0,0,0.9),
    rgba(0,0,0,0.15) 35%,
    rgba(0,0,0,0.15) 65%,
    rgba(0,0,0,0.95)
  );
}

/* title */
#title{
  position:fixed;
  top:16px;
  left:50%;
  transform:translateX(-50%);
  font-size:12px;
  letter-spacing:0.25em;
  opacity:0.6;
}

/* panel */
#panel{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  padding:22px 26px;
  box-sizing:border-box;
  background:linear-gradient(
    to top,
    rgba(0,0,0,0.98),
    rgba(0,0,0,0.75),
    rgba(0,0,0,0)
  );
}

/* numbers */
#ssi{
  font-size:56px;
  font-weight:600;
  letter-spacing:0.04em;
  text-shadow:0 0 12px rgba(255,255,255,0.35);
}

#ssi.ui-strong{
  font-size:72px;
}

.sub{
  display:flex;
  gap:32px;
  margin-top:10px;
  font-size:14px;
  opacity:0.8;
}

/* controls */
#controls{
  position:fixed;
  right:16px;
  bottom:140px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.ctrl{
  width:52px;
  height:52px;
  border-radius:50%;
  background:rgba(0,0,0,0.75);
  border:1px solid rgba(255,255,255,0.4);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  letter-spacing:0.1em;
  user-select:none;
}

.ctrl.active{
  background:#fff;
  color:#000;
}
</style>
</head>

<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="frame"></div>
<div id="title">STABILITY · STILLNESS · INDEX</div>

<div id="controls">
  <div class="ctrl" id="pause">PAUSE</div>
  <div class="ctrl" id="reset">RESET</div>
  <div class="ctrl" id="avg">AVG</div>
  <div class="ctrl" id="ui">UI</div>
</div>

<div id="panel">
  <div id="ssi">--</div>
  <div class="sub">
    <div>STABILITY <span id="stab">--</span></div>
    <div>STILLNESS <span id="still">--</span></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

const ssiEl=document.getElementById("ssi");
const stabEl=document.getElementById("stab");
const stillEl=document.getElementById("still");

let centers=[], angles=[], ssiHist=[];
let paused=false, useAvg=false, strongUI=false;

/* math */
function center(pts){
  return{
    x:(pts[0].x+pts[1].x+pts[2].x+pts[3].x)/4,
    y:(pts[0].y+pts[1].y+pts[2].y+pts[3].y)/4
  };
}
function angle(a,b){
  return Math.atan2(b.y-a.y,b.x-a.x);
}
function variance(arr){
  const m=arr.reduce((a,b)=>a+b,0)/arr.length;
  return arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;
}

/* buttons */
const btn=id=>document.getElementById(id);

btn("pause").onclick=()=>{
  paused=!paused;
  btn("pause").classList.toggle("active",paused);
};

btn("reset").onclick=()=>{
  centers=[];angles=[];ssiHist=[];
};

btn("avg").onclick=()=>{
  useAvg=!useAvg;
  btn("avg").classList.toggle("active",useAvg);
};

btn("ui").onclick=()=>{
  strongUI=!strongUI;
  ssiEl.classList.toggle("ui-strong",strongUI);
  btn("ui").classList.toggle("active",strongUI);
};

/* pose */
const pose=new Pose({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
});
pose.setOptions({
  smoothLandmarks:true,
  minDetectionConfidence:0.5,
  minTrackingConfidence:0.5
});

pose.onResults(r=>{
  ctx.drawImage(r.image,0,0,canvas.width,canvas.height);
  if(!r.poseLandmarks || paused) return;

  const ls=r.poseLandmarks[11];
  const rs=r.poseLandmarks[12];
  const lh=r.poseLandmarks[23];
  const rh=r.poseLandmarks[24];

  const c=center([ls,rs,lh,rh]);
  const a=Math.abs(angle(ls,rs)-angle(lh,rh));

  centers.push(c);
  angles.push(a);
  if(centers.length>60){centers.shift();angles.shift();}
  if(centers.length<20) return;

  const moves=centers.slice(1).map((p,i)=>
    Math.hypot(p.x-centers[i].x,p.y-centers[i].y)
  );

  const stability=Math.max(0,1-variance(moves)*500);
  const stillness=Math.max(0,1-variance(angles)*200);
  const ssi=Math.round((stability*0.6+stillness*0.4)*100);

  ssiHist.push(ssi);
  if(ssiHist.length>900) ssiHist.shift();

  const displaySSI=useAvg
    ? Math.round(ssiHist.reduce((a,b)=>a+b,0)/ssiHist.length)
    : ssi;

  ssiEl.textContent=displaySSI;
  stabEl.textContent=Math.round(stability*100);
  stillEl.textContent=Math.round(stillness*100);
});

/* camera */
const camera=new Camera(video,{
  onFrame:async()=>await pose.send({image:video}),
  width:640,
  height:480
});
camera.start();
</script>

</body>
</html>
