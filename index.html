<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bio Thermo Energy Monitor</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  color:#fff;
  overflow:hidden;
  font-family:system-ui,-apple-system;
}

video,canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ===== UI ===== */

#value{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-size:140px;
  font-weight:800;
  letter-spacing:.08em;
  text-shadow:
    0 0 20px rgba(255,255,255,.6),
    0 0 60px rgba(255,120,0,.6);
  pointer-events:none;
  mix-blend-mode:screen;
}

#energy{
  position:fixed;
  right:28px;
  top:60px;
  bottom:60px;
  width:22px;
  background:rgba(255,255,255,.12);
  border-radius:12px;
  overflow:hidden;
}

#energyFill{
  position:absolute;
  bottom:0;
  width:100%;
  height:50%;
  background:linear-gradient(
    to top,
    #0044ff,
    #00ffff,
    #ffff00,
    #ff3300
  );
}

#label{
  position:fixed;
  top:18px;
  left:50%;
  transform:translateX(-50%);
  font-size:12px;
  letter-spacing:.25em;
  opacity:.6;
}
</style>
</head>

<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="value">--</div>

<div id="energy">
  <div id="energyFill"></div>
</div>

<div id="label">BIO · THERMO · ENERGY · MONITOR</div>

<script>
/* ===============================
   SETUP
================================ */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const valueEl = document.getElementById("value");
const fillEl = document.getElementById("energyFill");

canvas.width = innerWidth;
canvas.height = innerHeight;

/* ===============================
   CAMERA
================================ */
navigator.mediaDevices.getUserMedia({video:true})
  .then(s => video.srcObject = s)
  .catch(e => alert(e));

/* ===============================
   THERMO STATE
================================ */
let prevFrame = null;
let energy = 0.5;
let t = 0;

/* ===============================
   UTILS
================================ */
function clamp(v,min,max){
  return Math.max(min,Math.min(max,v));
}

function heatColor(v){
  const r = Math.floor(255 * clamp((v-0.5)*2,0,1));
  const b = Math.floor(255 * clamp((0.5-v)*2,0,1));
  const g = Math.floor(255 * (1-Math.abs(v-0.5)*2));
  return `rgb(${r},${g},${b})`;
}

/* ===============================
   MAIN LOOP
================================ */
function loop(){
  t += 0.02;

  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const frame = ctx.getImageData(0,0,canvas.width,canvas.height);

  if(prevFrame){
    let diffSum = 0;
    const d = frame.data;
    const p = prevFrame.data;

    for(let i=0;i<d.length;i+=16){
      diffSum += Math.abs(d[i]-p[i]); // 輝度差
    }

    const activity = clamp(diffSum / (canvas.width*canvas.height) * 40, 0, 1);

    /* エネルギー更新（動き＋時間的減衰） */
    energy = energy * 0.85 + (1-activity) * 0.15;
  }

  prevFrame = frame;

  /* ベース呼吸 */
  const base = 0.45 + 0.1 * Math.sin(t);
  const e = clamp(base*0.4 + energy*0.6, 0, 1);

  /* ===============================
     VISUAL UPDATE
  ================================ */
  const percent = Math.round(e * 100);
  valueEl.textContent = percent;

  fillEl.style.height = (e * 100) + "%";
  fillEl.style.background = `linear-gradient(
    to top,
    #0033ff,
    #00ffff,
    #ffff00,
    #ff2200 ${percent}%
  )`;

  valueEl.style.color = heatColor(e);
  valueEl.style.textShadow =
    `0 0 ${20+e*60}px ${heatColor(e)}`;

  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
