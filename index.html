<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Bio-Tensegrity System</title>

<style>
html,body{
  margin:0;padding:0;background:#000;color:#fff;
  overflow:hidden;font-family:system-ui,-apple-system;
}
video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

/* UI */
#value{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  font-size:120px;font-weight:800;
  letter-spacing:.08em;mix-blend-mode:screen;
}
#level{
  position:absolute;left:50%;top:34%;
  transform:translateX(-50%);
  font-size:14px;letter-spacing:.25em;opacity:.7;
}
#energy{
  position:fixed;right:22px;top:60px;bottom:60px;
  width:14px;background:rgba(255,255,255,.15);
  border-radius:8px;overflow:hidden;
}
#energyFill{
  position:absolute;bottom:0;width:100%;height:50%;
  background:linear-gradient(to top,#0033ff,#00ffff,#ffff00,#ff3300);
}
#timer{
  position:fixed;bottom:22px;left:50%;
  transform:translateX(-50%);
  font-size:13px;letter-spacing:.18em;opacity:.7;
}
</style>
</head>

<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="level">LEVEL 1</div>
<div id="value">--</div>
<div id="energy"><div id="energyFill"></div></div>
<div id="timer">HOLD 60s</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const valueEl=document.getElementById("value");
const levelEl=document.getElementById("level");
const fillEl=document.getElementById("energyFill");
const timerEl=document.getElementById("timer");

canvas.width=innerWidth;
canvas.height=innerHeight;

/* CAMERA */
const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
pose.setOptions({modelComplexity:1,smoothLandmarks:true});
const camera=new Camera(video,{
  onFrame:async()=>await pose.send({image:video}),
  width:640,height:480
});
camera.start();

/* STATE */
let energy=0.5,level=1,holdTime=0,lastTime=performance.now(),t=0;
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

/* LOOP */
pose.onResults(r=>{
  const now=performance.now();
  const dt=(now-lastTime)/1000; lastTime=now; t+=dt;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(r.image,0,0,canvas.width,canvas.height);
  if(!r.poseLandmarks) return;

  const lm=r.poseLandmarks;
  const ls=lm[11],rs=lm[12],lh=lm[23],rh=lm[24];

  /* === 等身大スケール計算 === */
  const shoulderW=Math.hypot(ls.x-rs.x,ls.y-rs.y)*canvas.width;
  const torsoH=Math.hypot(
    (ls.x+rs.x)/2-(lh.x+rh.x)/2,
    (ls.y+rs.y)/2-(lh.y+rh.y)/2
  )*canvas.height;

  const cx=((ls.x+rs.x+lh.x+rh.x)/4)*canvas.width;
  const cy=((ls.y+rs.y+lh.y+rh.y)/4)*canvas.height;

  /* === 安定度 === */
  const sway=Math.abs(ls.x-rs.x);
  energy=energy*0.85+(1-clamp(sway*4,0,1))*0.15;

  if(sway<0.015){holdTime+=dt}else{holdTime=0}
  if(holdTime>=60){level++;holdTime=0}

  const e=clamp(energy,0,1);
  const display=Math.round(e*(100+level*20));

  valueEl.textContent=display;
  levelEl.textContent="LEVEL "+level;
  fillEl.style.height=(e*100)+"%";
  timerEl.textContent=holdTime>0?"HOLD "+Math.floor(60-holdTime)+"s":"HOLD 60s";

  /* === テンセグリティ描画 === */
  ctx.save();
  ctx.translate(cx,cy);

  const nodes=8+level;
  const halfH=torsoH*0.7;
  const halfW=shoulderW*0.6;

  const pts=[];
  for(let i=0;i<nodes;i++){
    const y=-halfH+(i/(nodes-1))*halfH*2;
    const swayX=(1-e)*10*Math.sin(t*2+i);
    pts.push({x:swayX,y});
  }

  /* 圧縮要素（骨） */
  ctx.strokeStyle=`rgba(255,220,160,${0.3+e*0.4})`;
  ctx.lineWidth=2;
  ctx.beginPath();
  pts.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
  ctx.stroke();

  /* 張力ケーブル */
  ctx.lineWidth=0.8;
  for(let i=0;i<pts.length-2;i++){
    const dir=i%2?1:-1;
    ctx.beginPath();
    ctx.moveTo(pts[i].x,pts[i].y);
    ctx.lineTo(pts[i+2].x+dir*halfW*0.4,pts[i+2].y);
    ctx.strokeStyle=`rgba(120,180,255,${0.15+e*0.35})`;
    ctx.stroke();
  }

  /* 螺旋筋膜 */
  ctx.beginPath();
  for(let i=0;i<pts.length;i++){
    const a=i*0.8+t;
    const x=Math.cos(a)*halfW*0.3;
    const y=pts[i].y;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  }
  ctx.strokeStyle=`rgba(180,140,255,${0.12+e*0.3})`;
  ctx.stroke();

  ctx.restore();
});
</script>

</body>
</html>
