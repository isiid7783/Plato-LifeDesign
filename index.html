<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stability–Stillness Index</title>

<style>
html,body{
  margin:0;
  padding:0;
  background:#000;
  font-family:system-ui,-apple-system;
  color:#e5e5e5;
  overflow:hidden;
}

/* camera */
video,canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

/* gradient frame */
#frame{
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    linear-gradient(
      to bottom,
      rgba(0,0,0,0.85) 0%,
      rgba(0,0,0,0.15) 30%,
      rgba(0,0,0,0.15) 70%,
      rgba(0,0,0,0.9) 100%
    );
}

/* panel */
#panel{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  padding:20px 24px;
  box-sizing:border-box;
  background:
    linear-gradient(
      to top,
      rgba(0,0,0,0.95),
      rgba(0,0,0,0.6),
      rgba(0,0,0,0.0)
    );
}

/* typography */
.label{
  font-size:11px;
  letter-spacing:0.18em;
  opacity:0.6;
}

.value{
  font-size:36px;
  font-weight:300;
  letter-spacing:0.05em;
  margin-top:6px;
}

.sub{
  display:flex;
  gap:32px;
  margin-top:12px;
}

.subItem{
  font-size:13px;
  opacity:0.75;
}

/* title */
#title{
  position:fixed;
  top:18px;
  left:50%;
  transform:translateX(-50%);
  font-size:12px;
  letter-spacing:0.22em;
  opacity:0.5;
}
</style>
</head>

<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="frame"></div>

<div id="title">STABILITY · STILLNESS · INDEX</div>

<div id="panel">
  <div class="label">STABILITY STILLNESS INDEX</div>
  <div class="value" id="ssi">--</div>
  <div class="sub">
    <div class="subItem">STABILITY <span id="stab">--</span></div>
    <div class="subItem">STILLNESS <span id="still">--</span></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

canvas.width=innerWidth;
canvas.height=innerHeight;

const ssiEl=document.getElementById("ssi");
const stabEl=document.getElementById("stab");
const stillEl=document.getElementById("still");

let centers=[];
let angles=[];

/* math */
function center(pts){
  return{
    x:(pts[0].x+pts[1].x+pts[2].x+pts[3].x)/4,
    y:(pts[0].y+pts[1].y+pts[2].y+pts[3].y)/4
  };
}

function angle(a,b){
  return Math.atan2(b.y-a.y,b.x-a.x);
}

function variance(arr){
  const m=arr.reduce((a,b)=>a+b,0)/arr.length;
  return arr.reduce((a,b)=>a+(b-m)*(b-m),0)/arr.length;
}

/* pose */
const pose=new Pose({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
});
pose.setOptions({
  smoothLandmarks:true,
  minDetectionConfidence:0.5,
  minTrackingConfidence:0.5
});

pose.onResults(r=>{
  ctx.drawImage(r.image,0,0,canvas.width,canvas.height);
  if(!r.poseLandmarks) return;

  const ls=r.poseLandmarks[11];
  const rs=r.poseLandmarks[12];
  const lh=r.poseLandmarks[23];
  const rh=r.poseLandmarks[24];

  const c=center([ls,rs,lh,rh]);
  const a=Math.abs(angle(ls,rs)-angle(lh,rh));

  centers.push(c);
  angles.push(a);

  if(centers.length>60){
    centers.shift();
    angles.shift();
  }

  if(centers.length<20) return;

  const moves=centers.slice(1).map((p,i)=>
    Math.hypot(p.x-centers[i].x,p.y-centers[i].y)
  );

  const stability=Math.max(0,1-variance(moves)*500);
  const stillness=Math.max(0,1-variance(angles)*200);

  const ssi=Math.round((stability*0.6+stillness*0.4)*100);

  ssiEl.textContent=ssi;
  stabEl.textContent=Math.round(stability*100);
  stillEl.textContent=Math.round(stillness*100);
});

/* camera */
const camera=new Camera(video,{
  onFrame:async()=>await pose.send({image:video}),
  width:640,
  height:480
});
camera.start();
</script>

</body>
</html>
